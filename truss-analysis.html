<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Truss Analysis - Kafka Design</title>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: Arial, sans-serif; }
        #sheet-container { width: 50%; height: 100%; }
        #viz-container { width: 50%; height: 100%; background: #f0f0f0; }
        #note { position: absolute; top: 10px; right: 10px; font-size: 14px; color: #333; }
        @media (max-width: 768px) { body { flex-direction: column; } #sheet-container, #viz-container { width: 100%; height: 50%; } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/konva@9.3.14/konva.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div id="sheet-container">
        <div id="sheet-placeholder" style="display: flex; flex-direction: column; height: 100%; justify-content: center; align-items: center; background: #f8f9fa; border: 2px dashed #dee2e6;">
            <h3>Google Sheet Integration</h3>
            <p>To display your spreadsheet here:</p>
            <ol style="text-align: left; max-width: 400px;">
                <li>Create a Google Sheet with "Nodes" and "Members" sheets</li>
                <li>Replace YOUR_SHEET_ID in the code with your actual sheet ID</li>
                <li>Replace YOUR_API_KEY with your Google Sheets API key</li>
                <li>Make your sheet publicly accessible</li>
            </ol>
            <p><strong>Current Status:</strong> <span id="status">Not configured</span></p>
        </div>
        <p style="text-align: center; margin-top: 10px;">
            <a href="#" id="edit-link" target="_blank" style="display: none;">Edit Sheet</a>
        </p>
    </div>
    <div id="viz-container"></div>
    <div id="note">Edit nodes/members in the sheet to update the truss</div>

    <script>
        // Replace these with your actual values
        const API_KEY = 'AIzaSyBQA4vNouNg8_h_nYUNwonBzdiABmSpjP8'; // Your Google Sheets API key
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SHEET_ID = '1ZSJXEtnPFiNdi3lygKtfm_M5f2gKoNH43pdAfid_7Jc'; // Your actual sheet ID
        
        let stage;
        let isConfigured = false;

        // Check if configuration is complete
        function checkConfiguration() {
            if (API_KEY !== 'YOUR_API_KEY' && SHEET_ID !== 'YOUR_SHEET_ID') {
                isConfigured = true;
                document.getElementById('sheet-placeholder').style.display = 'none';
                document.getElementById('edit-link').style.display = 'inline';
                document.getElementById('edit-link').href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`;
                document.getElementById('status').textContent = 'Configured - Loading...';
                initGapi();
            } else {
                document.getElementById('status').textContent = 'Not configured - Replace placeholders in code';
            }
        }

        async function initGapi() {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                document.getElementById('status').textContent = 'Connected - Updating visualization';
                updateViz();
                setInterval(updateViz, 5000); // Poll every 5s for updates
            } catch (error) {
                console.error('Error initializing GAPI:', error);
                document.getElementById('status').textContent = 'Error connecting to Google Sheets';
            }
        }

        function gapiLoaded() {
            gapi.load('client', initGapi);
        }

        async function updateViz() {
            try {
                // Fetch nodes
                const nodesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: 'Nodes!A1:C100'
                });
                const nodes = nodesResponse.result.values.slice(1).map(row => ({
                    id: row[0],
                    x: parseFloat(row[1]) * 20,
                    y: parseFloat(row[2]) * 20
                }));

                // Fetch members
                const membersResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: 'Members!A1:C100'
                });
                const members = membersResponse.result.values.slice(1).map(row => ({
                    from: row[1],
                    to: row[2]
                }));

                if (!stage) {
                    stage = new Konva.Stage({
                        container: 'viz-container',
                        width: window.innerWidth / 2,
                        height: window.innerHeight
                    });
                } else {
                    stage.destroyChildren();
                }
                const layer = new Konva.Layer();
                stage.add(layer);

                members.forEach(member => {
                    const fromNode = nodes.find(n => n.id === member.from);
                    const toNode = nodes.find(n => n.id === member.to);
                    if (fromNode && toNode) {
                        layer.add(new Konva.Line({
                            points: [fromNode.x, fromNode.y, toNode.x, toNode.y],
                            stroke: '#333',
                            strokeWidth: 2
                        }));
                    }
                });

                nodes.forEach(node => {
                    layer.add(new Konva.Circle({
                        x: node.x,
                        y: node.y,
                        radius: 5,
                        fill: '#1e90ff'
                    }));
                    layer.add(new Konva.Text({
                        x: node.x + 5,
                        y: node.y,
                        text: node.id,
                        fontSize: 12,
                        fill: '#333'
                    }));
                });

                layer.draw();
            } catch (error) {
                console.error('Error updating viz:', error);
                document.getElementById('status').textContent = 'Error updating visualization';
            }
        }

        // Initialize when page loads
        checkConfiguration();
        gapiLoaded();
    </script>
</body>
</html>